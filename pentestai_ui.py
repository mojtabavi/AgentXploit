"""
PentestAI Web UI - ChatGPT-style Interface
Provides interactive chat interface for penetration testing with GUI controls
"""

import gradio as gr
import os
import json
from datetime import datetime
from pathlib import Path
from typing import List, Dict, Any, Generator
import asyncio

from pentestai.core.controller import PentestAIController
from pentestai.core.config import PentestAIConfig


class PentestAIUI:
    """Web UI for PentestAI with ChatGPT-style interface"""
    
    def __init__(self):
        self.controller = None
        self.config = None
        self.current_mode = "pentest"  # Default mode
        self.history_dir = Path("pentestai_results")
        self.history_dir.mkdir(exist_ok=True)
        self.current_session = None
        
    def load_history(self) -> List[Dict[str, Any]]:
        """Load pentest history from results directory"""
        history = []
        
        if self.history_dir.exists():
            for file in sorted(self.history_dir.glob("pentestai_report_*.txt"), reverse=True)[:20]:
                try:
                    timestamp = file.stem.replace("pentestai_report_", "")
                    result_file = self.history_dir / f"pentestai_results_{timestamp}.json"
                    
                    if result_file.exists():
                        with open(result_file, 'r') as f:
                            data = json.load(f)
                            history.append({
                                "timestamp": timestamp,
                                "target": data.get("target", "Unknown"),
                                "mode": data.get("mode", "Unknown"),
                                "vulnerabilities": len(data.get("vulnerabilities", [])),
                                "file": str(file)
                            })
                except Exception as e:
                    print(f"Error loading history item: {e}")
        
        return history
    
    def format_history_list(self) -> str:
        """Format history as HTML list"""
        history = self.load_history()
        
        if not history:
            return "<p style='color: #666;'>No pentest history found</p>"
        
        html = "<div style='max-height: 400px; overflow-y: auto;'>"
        for item in history:
            time_str = datetime.strptime(item['timestamp'], "%Y%m%d_%H%M%S").strftime("%Y-%m-%d %H:%M:%S")
            html += f"""
            <div style='padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;'>
                <strong>üéØ {item['target']}</strong><br/>
                <small>üìÖ {time_str} | Mode: {item['mode']} | Vulns: {item['vulnerabilities']}</small>
            </div>
            """
        html += "</div>"
        return html
    
    def initialize_controller(
        self,
        target: str,
        mode: str,
        sandbox_mode: bool,
        use_mcp: bool,
        api_provider: str,
        api_key: str,
        arvancloud_endpoint: str,
        model_name: str
    ) -> str:
        """Initialize PentestAI controller with user settings"""
        try:
            # Map GUI mode names to internal mode strings
            mode_map = {
                "Reconnaissance": "pentest",
                "Vulnerability Scan": "pentest",
                "Exploitation": "pentest",
                "Full Assessment": "full",
            }
            
            # Configure API based on provider
            if api_provider == "ArvanCloud AI Gateway":
                base_url = arvancloud_endpoint or os.getenv("ARVANCLOUD_ENDPOINT")
                api_key_value = api_key or os.getenv("ARVANCLOUD_API_KEY")
                # ArvanCloud uses "apikey" prefix instead of "Bearer"
                os.environ["OPENAI_API_KEY"] = api_key_value
                default_model = model_name or "DeepSeek-R1-qwen-7b-awq"
                use_apikey_auth = True
            else:
                # OpenAI
                base_url = os.getenv("OPENAI_BASE_URL")
                api_key_value = api_key or os.getenv("OPENAI_API_KEY")
                default_model = "gpt-4"
                use_apikey_auth = False
            
            self.config = PentestAIConfig(
                target=target,
                openai_api_key=api_key_value,
                openai_base_url=base_url,
                use_apikey_auth=use_apikey_auth,
                planner_model=default_model,
                executor_model=default_model,
                advisor_model=default_model,
                evaluator_model=default_model,
                utility_model=default_model,
                sandbox_mode=sandbox_mode,
                use_mcp=use_mcp,
                kali_mcp_url=os.getenv("KALI_MCP_URL", "http://kali-mcp-server:5000"),
            )
            
            # Store the mode for later use
            self.current_mode = mode_map.get(mode, "pentest")
            
            self.controller = PentestAIController(self.config)
            self.current_session = datetime.now().strftime("%Y%m%d_%H%M%S")
            
            provider_name = "ArvanCloud" if api_provider == "ArvanCloud AI Gateway" else "OpenAI"
            return f"‚úÖ Initialized PentestAI for target: {target}\n- Mode: {mode}\n- Provider: {provider_name}\n- Model: {default_model}"
        
        except Exception as e:
            return f"‚ùå Error initializing: {str(e)}"
    
    def stream_pentest_response(
        self,
        message: str,
        history: List[List[str]],
        target: str,
        mode: str,
        sandbox_mode: bool,
        use_mcp: bool,
        api_provider: str,
        api_key: str,
        arvancloud_endpoint: str,
        model_name: str
    ) -> Generator[str, None, None]:
        """Stream pentest responses with thinking indicators"""
        
        # Initialize if needed
        if self.controller is None:
            init_msg = self.initialize_controller(target, mode, sandbox_mode, use_mcp, api_provider, api_key, arvancloud_endpoint, model_name)
            yield init_msg + "\n\n"
        
        # Handle different commands
        if message.lower() in ["start", "begin", "run pentest", "start pentest"]:
            yield "ü§î **Analyzing target and planning attack strategy...**\n\n"
            
            try:
                if self.current_mode == "full":
                    # Full assessment
                    yield "üìä **Running full assessment (Stage 1: Penetration Testing)...**\n\n"
                    
                    pentest_result, remediation_result = self.controller.run_full_assessment()
                    
                    yield f"‚úÖ **Stage 1 Complete!**\n\n"
                    yield f"**Vulnerabilities Found:** {len(pentest_result.vulnerabilities)}\n\n"
                    
                    for i, vuln in enumerate(pentest_result.vulnerabilities[:5], 1):
                        yield f"{i}. **{vuln.title}** (Severity: {vuln.severity})\n"
                        yield f"   - {vuln.description[:100]}...\n\n"
                    
                    yield "\nüîß **Stage 2: Generating Remediation Plan...**\n\n"
                    
                    yield f"**Remediation Strategies:** {len(remediation_result.selected_strategies)}\n\n"
                    
                    for i, strategy in enumerate(remediation_result.selected_strategies[:5], 1):
                        yield f"{i}. **{strategy.title}**\n"
                        yield f"   - Priority: {strategy.priority}\n"
                        yield f"   - Effort: {strategy.implementation_effort}\n\n"
                    
                else:
                    # Single stage
                    yield f"üîç **Running {mode} scan...**\n\n"
                    
                    result = self.controller.run_pentest()
                    
                    yield f"‚úÖ **Scan Complete!**\n\n"
                    yield f"**Vulnerabilities Found:** {len(result.vulnerabilities)}\n\n"
                    
                    for i, vuln in enumerate(result.vulnerabilities[:10], 1):
                        yield f"{i}. **{vuln.title}** ({vuln.severity})\n"
                        yield f"   - {vuln.description}\n\n"
                
                yield "\n‚úÖ **Assessment complete! Results saved to pentestai_results/**"
                
            except Exception as e:
                yield f"\n‚ùå **Error during assessment:** {str(e)}"
        
        elif message.lower() in ["help", "commands"]:
            yield """
üìñ **Available Commands:**

- **start** / **begin** - Start penetration test
- **history** - View past pentests
- **status** - Check current session status
- **help** - Show this help message

üí° **Tips:**
- Configure your target and mode in the sidebar
- Use sandbox mode for safe testing
- Enable MCP for real tool execution
            """
        
        elif message.lower() == "status":
            if self.controller:
                yield f"‚úÖ **Active Session**\n\n"
                yield f"- Target: {self.config.target}\n"
                yield f"- Mode: {self.current_mode}\n"
                yield f"- Sandbox: {self.config.sandbox_mode}\n"
                yield f"- MCP Enabled: {self.config.use_mcp}\n"
            else:
                yield "‚ö†Ô∏è No active session. Configure settings and type 'start' to begin."
        
        elif message.lower() == "history":
            yield "üìö **Loading pentest history...**\n\n"
            history_items = self.load_history()
            
            if not history_items:
                yield "No previous pentests found."
            else:
                for item in history_items[:10]:
                    time_str = datetime.strptime(item['timestamp'], "%Y%m%d_%H%M%S").strftime("%Y-%m-%d %H:%M:%S")
                    yield f"üéØ **{item['target']}**\n"
                    yield f"   - Date: {time_str}\n"
                    yield f"   - Mode: {item['mode']}\n"
                    yield f"   - Vulnerabilities: {item['vulnerabilities']}\n\n"
        
        else:
            # General chat with AI
            yield "ü§î **Thinking...**\n\n"
            
            if self.controller:
                # Use LLM for general questions
                yield f"üí¨ Processing your question: '{message}'\n\n"
                yield "This feature allows you to ask questions about security, vulnerabilities, or get explanations.\n\n"
                yield "For now, please use the following commands:\n"
                yield "- Type **'start'** to begin pentesting\n"
                yield "- Type **'help'** for available commands\n"
            else:
                yield "‚ö†Ô∏è Please configure your settings and type 'start' to initialize a session."


def create_ui():
    """Create the Gradio UI"""
    
    ui = PentestAIUI()
    
    # Custom CSS for ChatGPT-like appearance
    custom_css = """
    .gradio-container {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .chat-window {
        border-radius: 10px;
    }
    #component-0 {
        max-width: 1200px;
        margin: 0 auto;
    }
    """
    
    with gr.Blocks(title="PentestAI - AI-Powered Penetration Testing") as demo:
        
        gr.Markdown("""
        # üîí PentestAI - Interactive Penetration Testing Assistant
        ### AI-Powered Security Testing with ChatGPT-style Interface
        """)
        
        with gr.Row():
            # Main chat area (left side)
            with gr.Column(scale=3):
                chatbot = gr.Chatbot(
                    height=600,
                    label="PentestAI Assistant",
                    show_label=True,
                )
                
                with gr.Row():
                    msg_input = gr.Textbox(
                        placeholder="Type 'start' to begin pentest, or ask a question...",
                        show_label=False,
                        scale=9,
                        container=False,
                    )
                    send_btn = gr.Button("Send", variant="primary", scale=1)
                
                with gr.Row():
                    clear_btn = gr.Button("üóëÔ∏è Clear Chat", size="sm")
                    help_btn = gr.Button("‚ùì Help", size="sm")
                    status_btn = gr.Button("üìä Status", size="sm")
            
            # Settings and History (right sidebar)
            with gr.Column(scale=1):
                gr.Markdown("### ‚öôÔ∏è Configuration")
                
                target_input = gr.Textbox(
                    label="Target",
                    placeholder="192.168.1.100 or example.com",
                    value="192.168.1.100",
                )
                
                gr.Markdown("#### AI Provider")
                
                api_provider = gr.Dropdown(
                    label="AI Provider",
                    choices=["OpenAI", "ArvanCloud AI Gateway"],
                    value="ArvanCloud AI Gateway",
                    info="Select your AI service provider",
                )
                
                api_key_input = gr.Textbox(
                    label="API Key",
                    type="password",
                    placeholder="Your API key",
                    value="",
                    info="OpenAI or ArvanCloud API key",
                )
                
                arvancloud_endpoint = gr.Textbox(
                    label="ArvanCloud Endpoint",
                    placeholder="https://arvancloudai.ir/gateway/models/...",
                    value="https://arvancloudai.ir/gateway/models/GPT-5/5cqUyooCcKzlOOzaMQbFCJnVAUQdQ5Pu8xezZagp1-1-bsgFGvsg_eE6vEz4sXIv_Ocfdm1mxdqHhOOvZWy4R0K4urknNNy_RUV-RlaVpGoO5lnZ1qaMaBPnUZDsqGxqLk22pH7Km7nEfxNErjjkTMOpDZAXmajRUSs615UF6XCNuelk68gTDFdVynC-xszKv6Ps0yc3e6E7REs_2_drzt038CAwXrTpxG6Ax90OTyanEA/v1",
                    visible=True,
                    info="ArvanCloud gateway endpoint URL",
                )
                
                model_name_input = gr.Textbox(
                    label="Model Name",
                    placeholder="DeepSeek-R1-qwen-7b-awq",
                    value="DeepSeek-R1-qwen-7b-awq",
                    visible=True,
                    info="Model to use (ArvanCloud)",
                )
                
                gr.Markdown("#### Pentest Settings")
                
                mode_dropdown = gr.Dropdown(
                    label="Pentest Mode",
                    choices=[
                        "Reconnaissance",
                        "Vulnerability Scan",
                        "Exploitation",
                        "Full Assessment"
                    ],
                    value="Reconnaissance",
                )
                
                sandbox_checkbox = gr.Checkbox(
                    label="Sandbox Mode (Safe Testing)",
                    value=True,
                    info="Simulates commands without execution",
                )
                
                mcp_checkbox = gr.Checkbox(
                    label="Enable MCP (Real Tools)",
                    value=False,
                    info="Use Kali Linux tools via MCP",
                )
                
                gr.Markdown("---")
                gr.Markdown("### üìö Pentest History")
                
                history_display = gr.HTML(
                    value=ui.format_history_list(),
                    label="Recent Tests",
                )
                
                refresh_history_btn = gr.Button("üîÑ Refresh History", size="sm")
        
        # Event handlers
        def respond(message, chat_history, target, mode, sandbox, use_mcp, provider, api_key, endpoint, model):
            """Handle user message and generate response"""
            chat_history = chat_history or []
            chat_history.append([message, None])
            
            response = ""
            for chunk in ui.stream_pentest_response(message, chat_history, target, mode, sandbox, use_mcp, provider, api_key, endpoint, model):
                response += chunk
                chat_history[-1][1] = response
                yield chat_history
        
        def toggle_provider_fields(provider):
            """Show/hide fields based on selected provider"""
            if provider == "ArvanCloud AI Gateway":
                return gr.update(visible=True), gr.update(visible=True)
            else:
                return gr.update(visible=False), gr.update(visible=False)
        
        def send_quick_command(command):
            """Send a quick command"""
            return command
        
        # Wire up events
        api_provider.change(
            toggle_provider_fields,
            inputs=[api_provider],
            outputs=[arvancloud_endpoint, model_name_input],
        )
        
        msg_input.submit(
            respond,
            inputs=[msg_input, chatbot, target_input, mode_dropdown, sandbox_checkbox, mcp_checkbox, api_provider, api_key_input, arvancloud_endpoint, model_name_input],
            outputs=[chatbot],
        ).then(
            lambda: "",
            outputs=[msg_input],
        )
        
        send_btn.click(
            respond,
            inputs=[msg_input, chatbot, target_input, mode_dropdown, sandbox_checkbox, mcp_checkbox, api_provider, api_key_input, arvancloud_endpoint, model_name_input],
            outputs=[chatbot],
        ).then(
            lambda: "",
            outputs=[msg_input],
        )
        
        clear_btn.click(lambda: None, outputs=[chatbot])
        help_btn.click(lambda: "help", outputs=[msg_input])
        status_btn.click(lambda: "status", outputs=[msg_input])
        
        refresh_history_btn.click(
            lambda: ui.format_history_list(),
            outputs=[history_display],
        )
        
        # Add examples
        gr.Examples(
            examples=[
                ["start"],
                ["status"],
                ["help"],
                ["history"],
            ],
            inputs=msg_input,
            label="Quick Commands",
        )
        
        gr.Markdown("""
        ---
        ### üõ°Ô∏è Safety Notice
        ‚ö†Ô∏è **Always use Sandbox Mode** unless you have explicit authorization for real testing.
        
        **Quick Start:**
        1. Configure your target and settings in the sidebar
        2. Type **'start'** to begin penetration testing
        3. View results in the chat and check history panel
        
        **Commands:** `start`, `status`, `help`, `history`
        """)
    
    return demo


if __name__ == "__main__":
    # Load environment variables
    from dotenv import load_dotenv
    load_dotenv()
    
    # Check for API key
    if not os.getenv("OPENAI_API_KEY"):
        print("‚ö†Ô∏è  Warning: OPENAI_API_KEY not found in environment")
        print("   You can provide it in the UI or set it in .env file")
    
    # Create and launch UI
    demo = create_ui()
    demo.launch(
        server_name="0.0.0.0",
        server_port=7860,
        share=False,
        show_error=True,
    )
