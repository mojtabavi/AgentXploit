"""
Test PentestAI Framework - Verify installation and basic functionality
"""

import os
import sys

def test_imports():
    """Test that all modules can be imported"""
    print("Testing imports...")
    try:
        from pentestai import PentestAIController, PentestAIConfig
        from pentestai.llm import OpenAIClient, MockLLMClient
        from pentestai.models.data import Vulnerability, VulnerabilitySeverity
        from pentestai.core.pentest_module import PentestModule
        from pentestai.core.remediation_module import RemediationModule
        print("✓ All imports successful")
        return True
    except ImportError as e:
        print(f"✗ Import failed: {e}")
        return False

def test_config():
    """Test configuration system"""
    print("\nTesting configuration...")
    try:
        from pentestai import PentestAIConfig
        
        # Test direct instantiation
        config = PentestAIConfig(
            target="192.168.1.100",
            openai_api_key="test-key",
            sandbox_mode=True,
        )
        assert config.target == "192.168.1.100"
        assert config.sandbox_mode == True
        print("✓ Configuration creation successful")
        return True
    except Exception as e:
        print(f"✗ Configuration test failed: {e}")
        return False

def test_mock_llm():
    """Test mock LLM client (no API key required)"""
    print("\nTesting mock LLM client...")
    try:
        from pentestai.llm import MockLLMClient
        
        client = MockLLMClient()
        response = client.generate("Test prompt")
        
        assert response.content is not None
        assert response.tokens_used > 0
        print(f"✓ Mock LLM response: {response.content[:50]}...")
        return True
    except Exception as e:
        print(f"✗ Mock LLM test failed: {e}")
        return False

def test_controller_initialization():
    """Test controller initialization with mock LLM"""
    print("\nTesting controller initialization...")
    try:
        from pentestai import PentestAIController, PentestAIConfig
        
        config = PentestAIConfig(
            target="192.168.1.100",
            max_iterations=10,
            sandbox_mode=True,
            # No API key - should use mock client
        )
        
        controller = PentestAIController(config)
        assert controller.config.target == "192.168.1.100"
        assert controller.pentest_module is not None
        assert controller.remediation_module is not None
        print("✓ Controller initialized with mock LLM")
        return True
    except Exception as e:
        print(f"✗ Controller initialization failed: {e}")
        return False

def test_data_models():
    """Test data models"""
    print("\nTesting data models...")
    try:
        from pentestai.models.data import (
            Vulnerability,
            VulnerabilitySeverity,
            RemediationStrategy,
            RemediationType,
        )
        
        vuln = Vulnerability(
            name="Test Vulnerability",
            description="Test description",
            severity=VulnerabilitySeverity.HIGH,
            cvss_score=8.5,
            service="HTTP",
            port=80,
            exploit_method="Test method",
        )
        
        assert vuln.name == "Test Vulnerability"
        assert vuln.severity == VulnerabilitySeverity.HIGH
        
        strategy = RemediationStrategy(
            vulnerability_id=vuln.id,
            type=RemediationType.PATCH,
            description="Test remediation",
            commands=["test command"],
            estimated_time=30,
            risk_level="LOW",
        )
        
        assert strategy.type == RemediationType.PATCH
        print("✓ Data models working correctly")
        return True
    except Exception as e:
        print(f"✗ Data model test failed: {e}")
        return False

def test_openai_client_available():
    """Test if OpenAI client can be initialized (requires API key)"""
    print("\nTesting OpenAI client...")
    api_key = os.getenv("OPENAI_API_KEY")
    
    if not api_key:
        print("⚠ No OPENAI_API_KEY found - skipping real API test")
        print("  Set OPENAI_API_KEY to test real OpenAI integration")
        return True
    
    try:
        from pentestai.llm import OpenAIClient
        
        client = OpenAIClient(api_key=api_key, model="gpt-3.5-turbo")
        print("✓ OpenAI client initialized successfully")
        print("  Note: Not testing actual API call to avoid charges")
        return True
    except Exception as e:
        print(f"✗ OpenAI client initialization failed: {e}")
        return False

def run_all_tests():
    """Run all tests"""
    print("="*60)
    print("PentestAI Framework Test Suite")
    print("="*60)
    
    tests = [
        test_imports,
        test_config,
        test_mock_llm,
        test_controller_initialization,
        test_data_models,
        test_openai_client_available,
    ]
    
    results = []
    for test in tests:
        try:
            result = test()
            results.append(result)
        except Exception as e:
            print(f"✗ Test crashed: {e}")
            results.append(False)
    
    print("\n" + "="*60)
    print(f"Test Results: {sum(results)}/{len(results)} passed")
    print("="*60)
    
    if all(results):
        print("\n✓ All tests passed! Framework is ready to use.")
        print("\nNext steps:")
        print("  1. Set OPENAI_API_KEY environment variable")
        print("  2. Run: python quickstart.py")
        print("  3. Try: python -m pentestai.cli --help")
        return 0
    else:
        print("\n✗ Some tests failed. Please check the errors above.")
        return 1

if __name__ == "__main__":
    sys.exit(run_all_tests())
