services:
  # React UI (Frontend)
  pentestai-react-ui:
    container_name: pentestai-react-ui
    build:
      context: ./ui
      dockerfile: Dockerfile
    image: pentestai-ui:latest
    ports:
      - "3000:3000"  # React UI
    volumes:
      - ./ui:/app
      - /app/node_modules
    command: ["sh", "-lc", "bun install && bun run dev --host 0.0.0.0"]
    environment:
      - VITE_DEV_PROXY_TARGET=http://pentestai-api:8000
    networks:
      - pentestai-network
    depends_on:
      - pentestai-api

  # Documentation UI (Docsify)
  pentestai-docs:
    container_name: pentestai-docs
    build:
      context: ./docs
      dockerfile: ../Dockerfile.docs
    image: pentestai-docs:latest
    ports:
      - "3001:3001"  # Documentation
    volumes:
      - ./docs:/docs
    networks:
      - pentestai-network
    restart: unless-stopped

  # API Server (Backend)
  pentestai-api:
    container_name: pentestai-api
    build:
      context: .
      dockerfile: Dockerfile.api
    image: pentestai-api:latest
    ports:
      - "8000:8000"  # FastAPI
    volumes:
      - ./pentestai_results:/app/pentestai_results
    environment:
      # API Keys - Set in .env file
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
      - ARVANCLOUD_API_KEY=${ARVANCLOUD_API_KEY:-}
      - ARVANCLOUD_ENDPOINT=${ARVANCLOUD_ENDPOINT:-}
      - LLM_MODEL=${LLM_MODEL:-gpt-4}
      # Kali MCP URL (bridge network)
      - KALI_MCP_URL=http://kali-mcp-server:5000
      - PYTHONUNBUFFERED=1
    depends_on:
      kali-mcp-server:
        condition: service_healthy
    networks:
      - pentestai-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  # Kali Linux MCP Server - With HOST network access
  kali-mcp-server:
    container_name: kali-mcp-server
    build:
      context: .
      dockerfile: Dockerfile.kali-mcp
    image: kali-mcp:latest
    ports:
      - "5000:5000"  # MCP server
    environment:
      - MCP_SERVER_PORT=5000
      - PYTHONUNBUFFERED=1
    volumes:
      # Mount results for command outputs
      - ./kali_results:/opt/kali-mcp-server/results
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN  # For advanced pentesting operations
    security_opt:
      - apparmor:unconfined  # Allow pentesting tools to run
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health 2>/dev/null || curl http://localhost:5000/ >/dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    networks:
      - pentestai-network

# Custom network for non-host services
networks:
  pentestai-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.30.0.0/24
          gateway: 172.30.0.1

volumes:
  pentestai-results:
    driver: local
  kali-results:
    driver: local
