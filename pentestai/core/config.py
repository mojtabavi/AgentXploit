"""
Configuration System for PentestAI Framework

Supports configuration via:
- Python dictionaries
- JSON/YAML files
- Environment variables
"""

import json
import os
from dataclasses import asdict, dataclass, field
from pathlib import Path
from typing import Any, Optional


@dataclass
class PentestAIConfig:
    """
    Complete configuration for PentestAI framework.
    
    Pentest Module Settings:
        target: Target system IP address or hostname
        max_iterations: Maximum pentest iterations (default: 50)
        counterfactual_rounds: Number of counterfactual reasoning rounds (default: 3)
        use_instructor: Enable RAG-based Instructor agent (default: True)
        knowledge_base_path: Path to knowledge base (default: None = use built-in)
        
    Remediation Module Settings:
        remediation_budget: Total budget for remediation (default: 100.0)
        budget_per_vulnerability: Default budget per vulnerability (default: 4.0)
        cost_weights: Cost scoring weights for remediation types
        enable_optimization: Use Group Knapsack optimization (default: True)
        
    LLM Settings:
        planner_model: Model for Planner agent (default: "gpt-4")
        executor_model: Model for Executor agent (default: "gpt-4")
        advisor_model: Model for Advisor agent (default: "gpt-4")
        evaluator_model: Model for Evaluator agent (default: "gpt-4")
        utility_model: Model for utility agents (default: "gpt-3.5-turbo")
        temperature: LLM temperature (default: 0.7)
        max_tokens: Maximum tokens per request (default: 4096)
        
    Output Settings:
        output_directory: Directory for results (default: "./pentestai_results")
        save_attack_plan: Save attack plan tree (default: True)
        save_execution_history: Save command history (default: True)
        generate_report: Generate human-readable report (default: True)
        export_format: Export format - json, csv, html (default: "json")
        
    Safety Settings:
        sandbox_mode: Simulate commands only (default: True)
        require_confirmation: Require user confirmation for risky operations (default: False)
        max_command_length: Maximum command length (default: 500)
        blocked_commands: List of blocked command patterns (default: [])
    """
    
    # Pentest Module Settings
    target: str = ""
    max_iterations: int = 50
    counterfactual_rounds: int = 3
    use_instructor: bool = True
    knowledge_base_path: Optional[str] = None
    
    # Remediation Module Settings
    remediation_budget: float = 100.0
    budget_per_vulnerability: float = 4.0
    cost_weights: dict[str, float] = field(default_factory=lambda: {
        "patch": 2.0,
        "reconfigure": 2.0,
        "monitor": 3.0,
        "isolate": 5.0,
        "compensating_control": 7.0,
        "shutdown_service": 10.0,
    })
    enable_optimization: bool = True
    
    # LLM Settings
    openai_api_key: Optional[str] = None
    openai_base_url: Optional[str] = None
    planner_model: str = "gpt-4"
    executor_model: str = "gpt-4"
    advisor_model: str = "gpt-4"
    evaluator_model: str = "gpt-4"
    utility_model: str = "gpt-3.5-turbo"
    temperature: float = 0.7
    max_tokens: int = 4096
    api_key: Optional[str] = None
    
    # Output Settings
    output_directory: str = "./pentestai_results"
    save_attack_plan: bool = True
    save_execution_history: bool = True
    generate_report: bool = True
    export_format: str = "json"
    
    # Safety Settings
    sandbox_mode: bool = True
    require_confirmation: bool = False
    max_command_length: int = 500
    blocked_commands: list[str] = field(default_factory=lambda: [
        "rm -rf /",
        ":(){ :|:& };:",  # fork bomb
        "mkfs",
        "dd if=/dev/zero",
    ])

    @classmethod
    def from_env(cls, prefix: str = "PENTESTAI_") -> "PentestAIConfig":
        """
        Load configuration from environment variables.
        
        Example:
            export PENTESTAI_TARGET="192.168.1.100"
            export PENTESTAI_MAX_ITERATIONS=30
            config = PentestAIConfig.from_env()
        """
        config = cls()
        
        # Map env vars to config fields
        env_mappings = {
            f"{prefix}TARGET": "target",
            f"{prefix}MAX_ITERATIONS": "max_iterations",
            f"{prefix}COUNTERFACTUAL_ROUNDS": "counterfactual_rounds",
            f"{prefix}USE_INSTRUCTOR": "use_instructor",
            f"{prefix}REMEDIATION_BUDGET": "remediation_budget",
            f"{prefix}BUDGET_PER_VULNERABILITY": "budget_per_vulnerability",
            f"{prefix}OPENAI_API_KEY": "openai_api_key",
            f"{prefix}OPENAI_BASE_URL": "openai_base_url",
            f"{prefix}PLANNER_MODEL": "planner_model",
            f"{prefix}EXECUTOR_MODEL": "executor_model",
            f"{prefix}ADVISOR_MODEL": "advisor_model",
            f"{prefix}EVALUATOR_MODEL": "evaluator_model",
            f"{prefix}UTILITY_MODEL": "utility_model",
            f"{prefix}TEMPERATURE": "temperature",
            f"{prefix}MAX_TOKENS": "max_tokens",
            f"{prefix}API_KEY": "api_key",
            f"{prefix}OUTPUT_DIRECTORY": "output_directory",
            f"{prefix}SANDBOX_MODE": "sandbox_mode",
            f"{prefix}REQUIRE_CONFIRMATION": "require_confirmation",
        }
        
        # Also check for standard OpenAI env var
        if not config.openai_api_key:
            config.openai_api_key = os.getenv("OPENAI_API_KEY")
        
        for env_var, field_name in env_mappings.items():
            value = os.getenv(env_var)
            if value is not None:
                # Type conversion
                field_type = type(getattr(config, field_name))
                if field_type == bool:
                    setattr(config, field_name, value.lower() in ("true", "1", "yes"))
                elif field_type == int:
                    setattr(config, field_name, int(value))
                elif field_type == float:
                    setattr(config, field_name, float(value))
                else:
                    setattr(config, field_name, value)
        
        return config

    @classmethod
    def from_file(cls, path: str) -> "PentestAIConfig":
        """
        Load configuration from JSON or YAML file.
        
        Args:
            path: Path to configuration file
            
        Returns:
            PentestAIConfig instance
            
        Example:
            config = PentestAIConfig.from_file("config.json")
        """
        file_path = Path(path)
        
        if not file_path.exists():
            raise FileNotFoundError(f"Configuration file not found: {path}")
        
        # Load based on extension
        if file_path.suffix in [".json"]:
            with open(file_path, "r") as f:
                data = json.load(f)
        elif file_path.suffix in [".yaml", ".yml"]:
            try:
                import yaml
                with open(file_path, "r") as f:
                    data = yaml.safe_load(f)
            except ImportError:
                raise ImportError("PyYAML not installed. Install with: pip install pyyaml")
        else:
            raise ValueError(f"Unsupported file format: {file_path.suffix}")
        
        return cls(**data)

    def to_dict(self) -> dict[str, Any]:
        """Convert configuration to dictionary."""
        return asdict(self)

    def save_to_file(self, path: str) -> None:
        """
        Save configuration to JSON or YAML file.
        
        Args:
            path: Output file path
            
        Example:
            config.save_to_file("config.json")
        """
        file_path = Path(path)
        file_path.parent.mkdir(parents=True, exist_ok=True)
        
        data = self.to_dict()
        
        if file_path.suffix == ".json":
            with open(file_path, "w") as f:
                json.dump(data, f, indent=2)
        elif file_path.suffix in [".yaml", ".yml"]:
            try:
                import yaml
                with open(file_path, "w") as f:
                    yaml.safe_dump(data, f, default_flow_style=False)
            except ImportError:
                raise ImportError("PyYAML not installed. Install with: pip install pyyaml")
        else:
            raise ValueError(f"Unsupported file format: {file_path.suffix}")

    def validate(self) -> list[str]:
        """
        Validate configuration and return list of errors.
        
        Returns:
            List of validation error messages (empty if valid)
        """
        errors = []
        
        # Validate required fields
        if not self.target:
            errors.append("Target system must be specified")
        
        # Validate numeric ranges
        if self.max_iterations < 1:
            errors.append("max_iterations must be >= 1")
        
        if self.counterfactual_rounds < 0:
            errors.append("counterfactual_rounds must be >= 0")
        
        if self.remediation_budget < 0:
            errors.append("remediation_budget must be >= 0")
        
        if self.temperature < 0 or self.temperature > 2:
            errors.append("temperature must be between 0 and 2")
        
        if self.max_tokens < 1:
            errors.append("max_tokens must be >= 1")
        
        # Validate export format
        valid_formats = ["json", "csv", "html"]
        if self.export_format not in valid_formats:
            errors.append(f"export_format must be one of: {', '.join(valid_formats)}")
        
        return errors

    def __str__(self) -> str:
        """String representation of configuration."""
        lines = ["PentestAI Configuration:"]
        lines.append(f"  Target: {self.target}")
        lines.append(f"  Max Iterations: {self.max_iterations}")
        lines.append(f"  Counterfactual Rounds: {self.counterfactual_rounds}")
        lines.append(f"  Remediation Budget: {self.remediation_budget}")
        lines.append(f"  Planner Model: {self.planner_model}")
        lines.append(f"  Sandbox Mode: {self.sandbox_mode}")
        lines.append(f"  Output Directory: {self.output_directory}")
        return "\n".join(lines)


# Default configuration instance
DEFAULT_CONFIG = PentestAIConfig()
