"""
PentestAI Examples - Complete Usage Demonstrations

This file contains working examples demonstrating all features of the
PentestAI framework.
"""

import json
from datetime import datetime
from pathlib import Path

from pentestai import PentestAIController, PentestAIConfig
from pentestai.models.data import Vulnerability, VulnerabilitySeverity


def example_1_full_assessment():
    """
    Example 1: Complete two-stage assessment (Pentest + Remediation)
    
    This is the main use case - run complete penetration testing followed
    by optimal remediation planning.
    """
    print("\n" + "="*80)
    print("Example 1: Full Assessment")
    print("="*80)
    
    # Create configuration
    config = PentestAIConfig(
        target="192.168.1.100",  # Metasploitable2 VM
        max_iterations=30,
        counterfactual_rounds=3,
        remediation_budget=50.0,
        sandbox_mode=True,  # ALWAYS use True for safety!
        output_directory="./examples/output/full_assessment",
        generate_report=True,
    )
    
    # Initialize controller
    controller = PentestAIController(config)
    
    # Run full assessment
    pentest_result, remediation_result = controller.run_full_assessment()
    
    # Display results
    print(f"\nVulnerabilities Found: {len(pentest_result.vulnerabilities)}")
    for vuln in pentest_result.vulnerabilities:
        print(f"  - {vuln.name} ({vuln.severity.value}, CVSS: {vuln.cvss_score})")
    
    print(f"\nRemediation Strategies Selected: {len(remediation_result.selected_strategies)}")
    for strategy in remediation_result.selected_strategies:
        print(f"  - {strategy.description}")
        print(f"    Value: {strategy.value_score:.2f}, Cost: {strategy.cost_score:.2f}")
    
    print(f"\nTotal Value: {remediation_result.total_value:.2f}")
    print(f"Total Cost: {remediation_result.total_cost:.2f}")
    print(f"Budget Used: {remediation_result.budget_used:.1f}%")
    
    return pentest_result, remediation_result


def example_2_pentest_only():
    """
    Example 2: Pentest Module only (vulnerability discovery)
    
    Run only Stage 1 to discover vulnerabilities without remediation planning.
    """
    print("\n" + "="*80)
    print("Example 2: Pentest Only")
    print("="*80)
    
    config = PentestAIConfig(
        target="192.168.1.100",
        max_iterations=20,
        counterfactual_rounds=2,
        use_instructor=True,  # Use RAG-based guidance
        sandbox_mode=True,
        output_directory="./examples/output/pentest_only",
    )
    
    controller = PentestAIController(config)
    result = controller.run_pentest_only()
    
    print(f"\nPentest Statistics:")
    print(f"  Iterations: {result.statistics['total_iterations']}")
    print(f"  Tasks Executed: {result.statistics['tasks_executed']}")
    print(f"  Vulnerabilities Found: {result.statistics['vulnerabilities_found']}")
    print(f"  Counterfactual Rounds: {result.statistics['counterfactual_rounds']}")
    print(f"  Duration: {result.statistics['duration_seconds']:.2f}s")
    
    return result


def example_3_remediation_only():
    """
    Example 3: Remediation Module only (from existing vulnerabilities)
    
    Run only Stage 2 with pre-discovered vulnerabilities (e.g., from
    external scanner or previous pentest).
    """
    print("\n" + "="*80)
    print("Example 3: Remediation Only")
    print("="*80)
    
    # Create sample vulnerabilities (normally loaded from file)
    vulnerabilities = [
        Vulnerability(
            name="vsFTPd 2.3.4 Backdoor",
            description="Backdoor in vsFTPd 2.3.4 allowing remote code execution",
            severity=VulnerabilitySeverity.CRITICAL,
            cvss_score=10.0,
            cve_id="CVE-2011-2523",
            service="FTP",
            port=21,
        ),
        Vulnerability(
            name="UnrealIRCd Backdoor",
            description="Trojaned UnrealIRCd with backdoor command execution",
            severity=VulnerabilitySeverity.HIGH,
            cvss_score=7.5,
            cve_id="CVE-2010-2075",
            service="IRC",
            port=6667,
        ),
        Vulnerability(
            name="SQL Injection",
            description="SQL injection vulnerability in web application",
            severity=VulnerabilitySeverity.HIGH,
            cvss_score=8.5,
            service="HTTP",
            port=80,
        ),
    ]
    
    config = PentestAIConfig(
        remediation_budget=30.0,
        budget_per_vulnerability=4.0,
        enable_optimization=True,
        sandbox_mode=True,
        output_directory="./examples/output/remediation_only",
    )
    
    controller = PentestAIController(config)
    result = controller.run_remediation_only(vulnerabilities)
    
    print(f"\nRemediation Statistics:")
    print(f"  Strategies Generated: {len(result.all_strategies)}")
    print(f"  Strategies Selected: {len(result.selected_strategies)}")
    print(f"  Optimization Time: {result.optimization_time:.2f}s")
    print(f"  Budget Efficiency: {result.statistics['budget_efficiency']:.2f}")
    
    return result


def example_4_with_config_file():
    """
    Example 4: Using configuration file
    
    Load settings from JSON/YAML file for reproducible experiments.
    """
    print("\n" + "="*80)
    print("Example 4: Configuration File")
    print("="*80)
    
    # Create sample configuration file
    config_dir = Path("./examples/configs")
    config_dir.mkdir(parents=True, exist_ok=True)
    config_file = config_dir / "example_config.json"
    
    config_data = {
        "target": "192.168.1.100",
        "max_iterations": 25,
        "counterfactual_rounds": 2,
        "remediation_budget": 40.0,
        "use_instructor": True,
        "enable_optimization": True,
        "sandbox_mode": True,
        "output_directory": "./examples/output/config_based",
        "generate_report": True,
        "planner_model": "gpt-4",
        "executor_model": "gpt-4",
        "utility_model": "gpt-3.5-turbo",
    }
    
    with open(config_file, "w") as f:
        json.dump(config_data, f, indent=2)
    
    print(f"Configuration saved to: {config_file}")
    
    # Load configuration
    config = PentestAIConfig.from_file(str(config_file))
    
    print(f"\nLoaded configuration:")
    print(config)
    
    # Run assessment
    controller = PentestAIController(config)
    pentest_result, remediation_result = controller.run_full_assessment()
    
    return pentest_result, remediation_result


def example_5_custom_budget_optimization():
    """
    Example 5: Custom budget constraints and optimization
    
    Demonstrate different budget scenarios and their impact on remediation.
    """
    print("\n" + "="*80)
    print("Example 5: Budget Optimization Scenarios")
    print("="*80)
    
    # Create sample vulnerabilities
    vulnerabilities = [
        Vulnerability(
            name="Critical RCE", cvss_score=9.8,
            severity=VulnerabilitySeverity.CRITICAL, service="Web"
        ),
        Vulnerability(
            name="SQL Injection", cvss_score=8.5,
            severity=VulnerabilitySeverity.HIGH, service="DB"
        ),
        Vulnerability(
            name="XSS", cvss_score=6.1,
            severity=VulnerabilitySeverity.MEDIUM, service="Web"
        ),
        Vulnerability(
            name="Info Disclosure", cvss_score=4.3,
            severity=VulnerabilitySeverity.LOW, service="API"
        ),
    ]
    
    # Test different budgets
    budgets = [10.0, 20.0, 40.0, 80.0]
    
    for budget in budgets:
        print(f"\n--- Budget: {budget} ---")
        
        config = PentestAIConfig(
            remediation_budget=budget,
            enable_optimization=True,
            sandbox_mode=True,
        )
        
        controller = PentestAIController(config)
        result = controller.run_remediation_only(vulnerabilities)
        
        print(f"  Strategies Selected: {len(result.selected_strategies)}")
        print(f"  Total Value: {result.total_value:.2f}")
        print(f"  Total Cost: {result.total_cost:.2f}")
        print(f"  Budget Used: {result.budget_used:.1f}%")
        print(f"  Efficiency: {result.statistics['budget_efficiency']:.2f}")


def example_6_export_and_statistics():
    """
    Example 6: Exporting results and generating statistics
    
    Demonstrate different export formats and statistical analysis.
    """
    print("\n" + "="*80)
    print("Example 6: Export and Statistics")
    print("="*80)
    
    config = PentestAIConfig(
        target="192.168.1.100",
        max_iterations=15,
        remediation_budget=35.0,
        sandbox_mode=True,
        output_directory="./examples/output/exports",
        generate_report=True,
        save_attack_plan=True,
        export_format="json",
    )
    
    controller = PentestAIController(config)
    pentest_result, remediation_result = controller.run_full_assessment()
    
    # Get comprehensive statistics
    stats = controller.get_statistics(pentest_result, remediation_result)
    
    print("\n--- Comprehensive Statistics ---")
    print(json.dumps(stats, indent=2))
    
    # Export to different formats
    output_dir = Path(config.output_directory)
    
    # JSON export (already done by controller)
    print(f"\nResults exported to: {output_dir}")
    
    # Custom CSV export
    csv_file = output_dir / "vulnerabilities.csv"
    with open(csv_file, "w") as f:
        f.write("Name,Severity,CVSS,CVE,Service,Port\n")
        for vuln in pentest_result.vulnerabilities:
            f.write(f"{vuln.name},{vuln.severity.value},{vuln.cvss_score},"
                   f"{vuln.cve_id or 'N/A'},{vuln.service},{vuln.port or 'N/A'}\n")
    
    print(f"CSV export: {csv_file}")


def example_7_environment_variables():
    """
    Example 7: Configuration via environment variables
    
    Demonstrate loading configuration from environment (useful for CI/CD).
    """
    print("\n" + "="*80)
    print("Example 7: Environment Variables")
    print("="*80)
    
    import os
    
    # Set environment variables
    os.environ["PENTESTAI_TARGET"] = "192.168.1.100"
    os.environ["PENTESTAI_MAX_ITERATIONS"] = "20"
    os.environ["PENTESTAI_REMEDIATION_BUDGET"] = "45.0"
    os.environ["PENTESTAI_SANDBOX_MODE"] = "true"
    
    # Load from environment
    config = PentestAIConfig.from_env()
    
    print("Configuration loaded from environment:")
    print(f"  Target: {config.target}")
    print(f"  Max Iterations: {config.max_iterations}")
    print(f"  Budget: {config.remediation_budget}")
    print(f"  Sandbox Mode: {config.sandbox_mode}")
    
    # Clean up
    for key in list(os.environ.keys()):
        if key.startswith("PENTESTAI_"):
            del os.environ[key]


def main():
    """Run all examples."""
    print("\n")
    print("╔" + "="*78 + "╗")
    print("║" + " "*78 + "║")
    print("║" + "PENTESTAI EXAMPLES - Complete Usage Demonstrations".center(78) + "║")
    print("║" + " "*78 + "║")
    print("╚" + "="*78 + "╝")
    
    # Run examples
    try:
        example_1_full_assessment()
        example_2_pentest_only()
        example_3_remediation_only()
        example_4_with_config_file()
        example_5_custom_budget_optimization()
        example_6_export_and_statistics()
        example_7_environment_variables()
        
        print("\n" + "="*80)
        print("All examples completed successfully!")
        print("="*80)
        
    except Exception as e:
        print(f"\n❌ Error running examples: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
